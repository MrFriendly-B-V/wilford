# OAuth2 Proxy

Wilford supports running with [oauth2-proxy](https://oauth2-proxy.github.io/oauth2-proxy/). 
Using oaut2-proxy together with Wilford and nginx, you can protect static resources without needing to modify them.

## OAuth2 Config
Sample docker-compose file for running oauth2-proxy.
Replace the `CLIENT_ID` and `CLIENT_SECRET` with the ID and Secret generated by Wilford. Use `REDIRECT_URL` as the Redirect URL in Wilford.
The `COOKIE_SECRET` should be a securely generated random string.
```yml
version: '3.2'
services:
  oauth2_proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy
    environment:
      - "OAUTH2_PROXY_COOKIE_SECRET=VsZqXqHQzwdPUcEUDgNxmQvTRZ46DtlQr8q-HtomkL8="
      - "OAUTH2_PROXY_COOKIE_SECURE=true"
      - "OAUTH2_PROXY_COOKIE_DOMAIN=localhost"
      - "OAUTH2_PROXY_CLIENT_ID=NuWrxroZbOuhBL2ufHx9zj0qKT6XXQRg"
      - "OAUTH2_PROXY_CLIENT_SECRET=vwn0MqNbD9qAnvCbGns9sNtikWC7eTM2V7DIz85vcimtxm12"
      - "OAUTH2_PROXY_OIDC_ISSUER_URL=https://localhost:8443"
      - "OAUTH2_PROXY_REDIRECT_URL=https://localhost:8443/oauth2/callback"
      - "OAUTH2_PROXY_PROVIDER=oidc"
      - "OAUTH2_PROXY_EMAIL_DOMAINS=*"
      - "OAUTH2_PROXY_OIDC_EMAIL_CLAIM=sub_email"
      - "OAUTH2_PROXY_PROVIDER_DISPLAY_NAME=Koala"
      - "OAUTH2_PROXY_CUSTOM_SIGN_IN_LOGO=-"
      - "OAUTH2_PROXY_BANNER=<img src='https://public.svsticky.nl/logos/logo_outline_kleur.png'/>"
      - "OAUTH2_PROXY_FOOTER=-"
    network_mode: "host"
```

## Nginx auth_directive
Using this setup, you can use the nginx auth directive very easily:
```conf
    location /secure {
        auth_request /oauth2/auth;
        error_page 401 =403 /oauth2/sign_in;
        proxy_pass http://my-secure-backend;
    }
```

## Localhost
The JWKS specification requires it be served over https. When working locally, this can be a bit of a pain.

### Generate certificates for localhost
Install the required tools:
```bash
sudo apt install -y libnss3-tools mkcert
```
Generate a CA cert:
```bash
mkcert --install
```

Generate SSL certificate for `localhost`, from the repository root:
```bash
mkcert localhost
```

### Oauth2-proxy
Add the following to the docker-compose file:
```yml
volumes:
  - "/usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro"
  - "/etc/ssl/certs:/etc/ssl/certs:ro"
```

### nginx
Use the following block for Wilford:
```conf
server {
    listen 8443 ssl default_server;
    server_name _;

    ssl_certificate /etc/ssl/certs/ssl-cert-localhost.pem;
    ssl_certificate_key /etc/ssl/private/ssl-cert-localhost.key;

    location / {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://localhost:2521;
    }
}
```
docker-compose:
```yml
  nginx:
    image: nginx
    network_mode: "host"
    volumes:
      - "./localhost.pem:/etc/ssl/certs/ssl-cert-localhost.pem"
      - "./localhost-key.pem:/etc/ssl/private/ssl-cert-localhost.key"
      - "./nginx.conf:/etc/nginx/conf.d/default.conf:ro"
```